\section{Analog Front End}

In this section, the complete Analog Front End circuit will be presented. This is composed by four different stages, the Pre-Amp stage, the Filter, a Peak Detector and finally a Comparator. The complete circuit can be seen in Figure \ref{fig:CompleteAFE}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.45]{Images/CompleteAFE.png}
    \caption{Analog Front End full circuit.}
    \label{fig:CompleteAFE}
\end{figure}

\subsection{Pre-Amp}

\subsubsection{Design}

To design the Pre-Amp stage, the variation of the output voltage of the Electret microphone used is critical to define the total gain of this circuit, so the sensibility of the microphone used is described by the following equation:

\begin{equation}
    Sens_{dBV} = 20 \cdot log_{10} (\frac{Sens_{mv/Pa}}{\SI{1000}{\milli\volt}/\si{\pascal}})
    \label{eq:SensdBV}
\end{equation}

So the output voltage in function of the Sound Pressure Level in dB (SPLdB), can be obtained from equation \ref{eq:VoltageSPLdB}.

\begin{equation}
    V_{in} = 10^{\frac{SPLdB-42}{20} \cdot \frac{20e^{-6}}{\sqrt{2}} } \cdot 1000 [\si{\milli\volt}]
    \label{eq:VoltageSPLdB}
\end{equation}

Resulting in the graphic of Figure \ref{fig:GraphSPLdB}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.3]{Images/GraphSPLdB.png}
    \caption{Electret microphone voltage in function of SPLdB.}
    \label{fig:GraphSPLdB}
\end{figure}

For this project, the SPLdB obtained by the human voice is the most important, and the gain of the Pre-Amp will depend on this factor, if the gain is too low, the output voltage will also be to low for the desired range, but if this gain is too high, the output voltage for the human voice may reach the supply voltage and so, the signal generated by the voice would be lost after this process, resulting in a simple DC value equal to the supply voltage, and only sounds with a lower SPLdB would have an effect on the remaining of the circuit.

So, considering that the human voice SPLdB is contained in $[60, 70]dB$, the output voltage of the Electret microphone will be $[0.112, 0.355]\si{\milli\volt}$, respectively.

With this information, the total gain of the Pre-Amp circuit needs to a high value, to avoid using resistors with very high, or very low resistance values, two Inverter circuits connected in series, as shown in figure \ref{fig:PreAmp}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.5]{Images/PreAmp circuit.png}
    \caption{Pre-Amp circuit.}
    \label{fig:PreAmp}
\end{figure}

The resulting AC component of the output voltage is described by equation \ref{eq:PreAmpEq}.

\begin{equation}
    v_{amp} = G_1 \cdot G_2 \cdot v_{in} = \frac{R_{b1}}{R_{a1}} \cdot \frac{R_{b2}}{R_{a2}} \cdot v_{in} [\si{\volt}]
    \label{eq:PreAmpEq}
\end{equation}

To obtain a maximum value of approximately $1V$, a gain of $2800$ is taken into account for this circuit, so assuming $R_{a1} = R_{a2} = 1k\Omega$, the final values for the remaining two resistors will be, $R_{b1} = 40k\Omega$ and $R_{b2} = 70k\Omega$.

In order to guarantee a DC component of $V_{CC}/2$ in the amplified signal, in a single supply circuit, an DC voltage, generated by the circuit in Figure \ref{fig:VrefVcomp} is added to the positive input node of both OpAmps, and finally, by using two capacitors with high capacitive, the DC component after both stages is $V_{CC}/2$.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.3]{Images/VrefVcomp.png}
    \caption{$V_{ref}$ and $V_{comp}$ circuit.}
    \label{fig:VrefVcomp}
\end{figure}

\subsubsection{Simulation}

Using the program LTSpice, the response of the Pre-Amp circuit for both cases mentioned above is obtained through a transient simulation.

The results for two Sine waves equal to $V_{in} = 2 + 0.112e^{-3} \cdot sin(2\pi 1k \cdot t)$ and $V_{in} = 2 + 0.355e^{-3} \cdot sin(2\pi 1k \cdot t)$, i.e., for a SPLdB of $60$ and $70 dB$, respectively, are shown in Figure \ref{fig:SimPreAmp}.

\begin{figure}[H]
    \centering
    \begin{subfigure}{0.45\textwidth}
        \includegraphics*[width=\textwidth]{Images/SimAmp112.png}
        \caption{$V_{amp}$ for $60dB$.}
        \label{fig:SimAmp112}  
    \end{subfigure}
    \begin{subfigure}{0.45\textwidth}
        \includegraphics*[width=\textwidth]{Images/SimAmp355.png}
        \caption{$V_{amp}$ for $60dB$}
        \label{fig:SimAmp355}    
    \end{subfigure}
    \caption{$V_{amp}$ for a SPLdB of $60$ and $70dB$}
    \label{fig:SimPreAmp}
\end{figure}

Other way to visualize the response of this circuit is through the AC analysis, the resulting are shown in Figure \ref{fig:SimAmpFreq}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.25]{Images/SimAmpFreq.png}
    \caption{Bode diagram of the Pre-Amp circuit.}
    \label{fig:SimAmpFreq}
\end{figure}

Despite showing a band-pass filter response, the Pre-Amp circuit will not have an effect in the signal generated by the human voice, given that the frequency of this signal will be contained in $[100, 4k]\si{\hertz}$.

To evaluate the Pre-Amp sensibility to variations in the values of its components, the Monte-Carlo analysis should be used, therefore, the Monte-Carlo analysis of the Pre-Amp circuit can be observed in Figure \ref{fig:Monte-carloPreAmp}, assuming a tolerance of $5\%$ for the resistance as well as the capacitance values.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.25]{Images/Monte-carloPreAmp.png}
    \caption{Monte-Carlo analysis of the Pre-Amp circuit.}
    \label{fig:Monte-carloPreAmp}
\end{figure}

Analyzing the graphic above, the maximum variation of the gain for the desired frequencies is approximately $3dB$, witch represents a variation that will not negatively affect the final result of this circuit, given that the input voltage is too low to reach the supply voltage value.

\subsection{Analog Filter}

\subsubsection{Filter Type and Approximation}

In filter design, the first step is to evaluate the filter type and the corresponding Passband and Stopband regions. For that, a Cutoff and a Stop frequency must be defined.

Since the signal generated by the human voice is contained in $[100, 4k]\si{\hertz}$, the Band-Pass filter is the right choice for this project. For this type of filter, the Passband is contained between two different Cutoff frequencies, so, the filter designed must meet the following conditions:

\begin{itemize}
    \item First Cutoff Frequency $f_1: 200\si{\hertz}$;
    \item Second Cutoff Frequency $f_2: 4000\si{\hertz}$;
    \item Central Frequency $f_c: \sqrt{f_1 f_2} = 895 \si{\hertz}$;
    \item Maximum Ripple in the Passband : $1dB$;
    \item Order : $6th$.
\end{itemize}

After choosing the filter speciations, a filter response approximation must be chosen as well. For this case, the only factor to consider for this choice is the frequency response of each approximation, the phase and group delay will not have any major influence, given that there is no need to maintain the signal integration for the remaining of the AFE circuit.

With these considerations in mind, in Figure \ref{fig:FilterResponse}, are on display the different frequency response for the four main approximations.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.3]{Images/FilterBode.png}
    \caption{Frequency response comparison.}
    \label{fig:FilterResponse}
\end{figure}

The desired approximation is the one that most resembles the ideal filter response, that is, the one with the sharpest drop in the Transition band, region where the magnitude goes from $0dB$ to $-40dB$. Following this factor, the best approximation will be the Elliptical approximation, but, implementing the resulting equation in an Active Filter circuit, would require much greater complexity than then what is possible to implement using all the available components. Because of that, the second-best approximation, the Chebyshev approximation was chosen for this application. 

To better improve the result of the filter, the Passband was shrunk by increasing the Fisrt Cutoff Frequency from $200\si{\hertz}$ to $350\si{\hertz}$ and reducing the Second Cutoff frequency from $4000\si{\hertz}$ to $3500\si{\hertz}$, sacrificing a small portion of desired frequencies, but also eliminating frequencies that were not intended. The Bode diagram of the resulting filter approximation can be seen in Figure \ref{fig:FilterFinal}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.3]{Images/FilterFinal.png}
    \caption{Final Filter Bode Diagram.}
    \label{fig:FilterFinal}
\end{figure}

Which can be described by the following equation:

\begin{equation}
    \begin{aligned}
        & \frac{7.2 \cdot 10^{19} s^{6}}{1.0 s^{12} + 3.0 \cdot 10^{3} s^{11} + 2.8 \cdot 10^{7} s^{10} + 6.0 \cdot 10^{10} s^{9} + 2.3 \cdot 10^{14} s^{8} + 3.2 \cdot 10^{17} s^{7} + 5.8 \cdot 10^{20} s^{6} + } \\
        &\\
        & \frac{}{ + 4.0 \cdot 10^{23} s^{5} + 3.7 \cdot 10^{26} s^{4} + 1.2 \cdot 10^{29} s^{3} + 7.0 \cdot 10^{31} s^{2} + 9.6 \cdot 10^{33} s + 4.0 \cdot 10^{36}} \\
        &      
    \end{aligned}    
    \label{eq:FilterFT}
\end{equation}

\subsubsection{Filter Topology}

The next step in the design of a filter is to choose the filter topology. There are two main options, the most common Sallen-Key topology, and the Multiple Feedback topology. The implementation of both topologies is quite similar and the decision between these two approaches for the final filter implemented will be decided after analyzing their behavior in the simulations.

\subsubsection{Sallen-Key Filter Design and Simulation}

First, the Sallen-Key topology was implemented, by using three Second Order Bandpass Filters, equal to the filter in Figure \ref{fig:SingleSK}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.3]{Images/SingleSK.png}
    \caption{Sallen-Key Second Order Bandpass Filter}
    \label{fig:SingleSK}
\end{figure}

With this topology, the complete Sixth order filter is shown in Figure \ref{fig:SKFilter}. 

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.4]{Images/SKFilter.png}
    \caption{Complete Sallen-Key Sixth Order Bandpass Filter}
    \label{fig:SKFilter}
\end{figure}

Using the AC analysis from LTSpice, the Frequency Response graphic is obtained, and this can be observed in Figure \ref{fig:SimSKFilter}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.25]{Images/SimSKFilter.png}
    \caption{Bode Diagram of the Sallen-Key Filter}
    \label{fig:SimSKFilter}
\end{figure}

Analyzing the Bode Diagram above, it is possible to observe that exists a small gain of approximately $5dB$, and a ripple above $1dB$, this difference in the filter behavior due to the restriction on the values of the resistors capacitors, since only the series E12 are available. So it is possible to assume that the Sallen-Key topology is quite sensitive to changes in its components. On the other end, the size of the Passband and the location of both Cutoff Frequencies did not suffer major changes. 

To confirm the question of the filter's sensibility, a Monte-Carlo analysis was made, with the results in Figure \ref{fig:Monte-CarloSKFilter}.
\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.25]{Images/Monte-CarloSK.png}
    \caption{Monte-Carlo analysis of the Sallen-Key Filter}
    \label{fig:Monte-CarloSKFilter}
\end{figure}

This graphic proves that the filter is very sensitive to changes, even having instable pole near the first Cutoff Frequency on two iterations and in other iterations, the overshoot in this area reach almost $40 dB$, this is not a good factor when designing a filter for any application. Other factor that influences the choice of the topology is the noise generated by every component in the circuit. Using the Noise analysis of LTSpice, the noise per resistor and total noise is shown in Figure\ref{fig:NoiseSK}.

\begin{figure}[H]
    \centering
    \begin{subfigure}{0.45\textwidth}
        \includegraphics*[width=\textwidth]{Images/NoiseResSK.png}
        \caption{Noise generated by each resistance.}
        \label{fig:NoiseResSk}  
    \end{subfigure}
    \begin{subfigure}{0.45\textwidth}
        \includegraphics*[width=\textwidth]{Images/NoiseTotalSK.png}
        \caption{Total Noise output}
        \label{fig:NoiseTotalSK}    
    \end{subfigure}
    \caption{Noise generated by the Sallen-Key Filter}
    \label{fig:NoiseSK}
\end{figure}

The total RMS noise is $146.78 \mu V / \sqrt{\si{\hertz}}$, this value is not favorable for this circuit, this value is the result of resistors with very high resistance values, like, e.g. $1M\Omega$.

\subsubsection{Multiple Feedback Filter Design and Simulation}

Moving on to the Multiple Feedback Filter Topology, the implementation of the complete filter is the same as in the previous case, three Second Order Bandpass Filters, equal to the one shown in figure \ref{fig:SingleMFB}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.3]{Images/SingleMFB.png}
    \caption{Multiple Feedback Second Order Bandpass Filter}
    \label{fig:SingleMFB}
\end{figure}

So, the complete Sixth Order Bandpass Filter can is displayed in Figure \ref{fig:MFBFilter}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.4]{Images/MFBFilter.png}
    \caption{Complete Multiple Feedback Sixth Order Bandpass Filter}
    \label{fig:MFBFilter}
\end{figure}

Repeating the same simulation process as before, first, the filter Frequency response is expressed in Figure \ref{fig:SimMFBFilter}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.25]{Images/SimMFBFilter.png}
    \caption{Bode Diagram of the Multiple Feedback Filter}
    \label{fig:SimMFBFilter}
\end{figure}

Unlike the Sallen-Key filter, the Multiple Feedback filter presents the expected Frequency Response, with the correct unitary gain and ripple lower than $1dB$, even with the same restriction cause by the series E12 of the components. Added to this point comes the fact that the Passband is equal to the theoretically determined. 

Even so, sensitivity analysis is crucial to verify any design, therefore, the Monte-Carlo analysis of the Multiple Feedback filter can be seen in Figure \ref{fig:Monte-CarloMFBFilter}.

\begin{figure}[H]
    \centering
    \includegraphics*[scale = 0.25]{Images/Monte-CarloMFB.png}
    \caption{Monte-Carlo analysis of the Multiple Feedback Filter}
    \label{fig:Monte-CarloMFBFilter}
\end{figure}

Just like the previous case, this graphic proves the assumption presented, but, for this time, the Monte-Carlo analysis proves that any variation in any component in this circuit will have a minimum effect in the final response, given that the maximum variation with the same tolerance of $5\%$ in every component is only of $3dB$, in the Passband gain, without any iteration with a different behavior like before. This is a very positive factor for the design of any circuit.

Lastly, using the Noise analysis the noise per resistor and total noise is shown in Figure\ref{fig:NoiseMFB}.

\begin{figure}[H]
    \centering
    \begin{subfigure}{0.45\textwidth}
        \includegraphics*[width=\textwidth]{Images/NoiseResMFB.png}
        \caption{Noise generated by each resistance.}
        \label{fig:NoiseResMFB}  
    \end{subfigure}
    \begin{subfigure}{0.45\textwidth}
        \includegraphics*[width=\textwidth]{Images/NoiseTotalMFB.png}
        \caption{Total Noise output}
        \label{fig:NoiseTotalMFB}    
    \end{subfigure}
    \caption{Noise generated by the Multiple Feedback Filter}
    \label{fig:NoiseMFB}
\end{figure}

The total RMS noise is $16.053\mu \si{\volt}\sqrt{\si{\hertz}}$, although this value is lower than the generated by the Sallen-Key filter, it still is quite high, the main responsible component for this value, higher than expected, is the OpAmp chosen for this project.

In conclusion, the Multiple Feedback topology is better than the Sallen-Key topology in all the factor considered for this project, and because of that, this was the chosen topology.